# Vibration Sensor

## A. Project Overview

This is a tool to read the PDM signal output of the vibration sensor, V2S200DZ [1] from Syntiant, by STM32H755ZI, and then transfer the PCM signal output to PC over USB. At the PC end, it stores the data received in csv format, and then analyze the frequency components.   

### 1. Firmware / Hardware

- Resources utilization:   

| Resource              | Quantity  | Description   |
| ---------             | --------- | ------------- |
| DFSDM                 | 1 channel, 1 filter | Read the PDM signal and converts to PCM format|
| DMA1                  | 1 stream  | Transfer the PCM signal converted by DFSDM to the buffer |
| OTG_HS2 (USB OTG_FS)  | 1         | Transfer the PCM data from buffer to PC over USB device CDC |
| SRAM (PCM buffer)     | 10000 bytes   | The double buffer of PCM data |
| SRAM (USB buffer)     | 5012 bytes    | The buffer for a frame of USB CDC transfer which contains start of frame, end of frame, and a timestamp |
| CPU (Post processing) | ~2 ms every 100 ms    | The CPU needs to do some post-process to the PCM data from DFSDM and starts the transfer to USB every 100 ms. |
| GPIO                  | PC2, PC3      | Physical connections from STM32H755ZI to the sensor: PDM_CLK -> PC2, PDM_DATA -> PC3, PDM_Sel -> GND |

- Overview

It utilizes the peripheral, DFSDM on the STM32H755ZI MCU, to acquire the 1-bit PDM data from the sensor in 3.2MHz sampling rate by a channel and then convert to 23-bit PCM signals in 12.5kHz sampling rate. If you need to modify the clock configuration, notice that the DFSDM is currently configured APB2 as its clock source. **Please keep the ratio of the APB2 clock frequency and the divider of DFSDM to be 3.2MHz which is the sampling frequency of the 1-bit PDM signal.** You can refer to [1] for the sampling frequency required by the sensor or refer to [3] for the clock source selection of DFSDM. 

The DMA transfers the filtered output of DFSDM and fills half of the buffer every 100 ms which triggers the CPU to process the data to be a frame and send it over USB. A frame constitutes of a start of frame (SOF),  a timestamp, 1250 PCM samples, and an end of frame (EOF). Each of them are 32-bit integers. SOF and EOF are currently set to be 0x55555555 and 0xAAAAAAAA respectively. SOF and EOF are at the start and the end of a frame which are not restricted to be 0x55555555 and 0xAAAAAAAA while you should make sure that their pattern can not be generated by DFSDM in view of bytes and update the macros in the aquisition software make it identifiable. For example, the output of DFSDM are 24-bit signed integers. While it cannot generate 0x7FFFFFFF, which is 2147483647, the maximum of a 32-bit signed int, directly, it can generate this pattern by 2 samples like: 0x0000007F followed by 0xFFFFFF00, which are 127 and -256 in decimal representation in the range of DFSDM output. As a result, 0x7FFFFFFF is not a proper choose of either SOF or EOF. Following SOF, the timestamp in the frame is an unsigned integer representing the time since the MCU startup in milliseconds. The PCM samples followed by EOF are 1250 23-bit resolution signed integers in 32-bit format with sign-extension.

### 2. Acquisition on PC

By connecting the MCU with the PC via USB, the PCM data can be received and processed on the PC. The USB CDC (Communication Device Class) interface allows the PC to communicate with the MCU as a virtual COM port.

Currently, the program for acquisition is only available for linux platforms. If you are windows 10/11 users, you can use WSL (Windows Subsystem for Linux) to run the linux program. And please refer to [5] for more details on how to connect USB devices on WSL.

The acquisition software reads the PCM data from the USB virtual COM port and saves it to a file in CSV format in ASCII for further analysis. The CSV file contains 2 columns: time (us) and amplitude (PCM value). The time for each sample is derived by the timestamp on each frame and the sampling rate. If you've modified the sampling rate or SOF as well as EOF in the firmware, please ensure that the acquisition software is updated accordingly.

### 3. Frequency Analysis

The frequency analysis is done by the Python program. It analyzes the PCM data using techniques such as the Fast Fourier Transform (FFT) and Welch's method for estimating the Power Spectral Density (PSD). The resulting frequency spectrum can provide insights into the dominant frequencies present in the vibration signal.

## B. Features / Specifications

- Limited by the sensor, the bandwidth is about 20Hz to 1kHz.
- The acceleration can be estimated from the PCM value using the formula:
  $$ accel \approx pcm \times \frac{17.7828}{2^{23}} \text{ g} $$
- Please refer to [1] for more details on the sensor specifications.

## C. File Structure 

```
VibrationSensor-V2S200DZ/
├── README.md                     # Project documentation
├── analyze_vibration.py                # Python frequency analysis tool
├── read_cdc.c                          # C program for USB CDC data acquisition
└── vibration_dfsdm/                    # STM32 firmware project
    ├── vibration_dfsdm.ioc             # STM32CubeMX configuration file
    ├── .project, .mxproject             # Eclipse/STM32CubeIDE project files
    ├── CM4/                            # Cortex-M4 core files (unused in this project)
    ├── CM7/                            # Cortex-M7 core files (main application)
    │   ├── .project, .cproject          # Eclipse project configuration
    │   ├── Core/                       # Core application files
    │   │   ├── Inc/                    # Header files
    │   │   │   ├── main.h              # Main application header
    │   │   │   ├── stm32h7xx_hal_conf.h # HAL configuration
    │   │   │   ├── stm32h7xx_it.h      # Interrupt handlers header
    │   │   │   └── stm32h7xx_nucleo_conf.h # Nucleo board configuration
    │   │   ├── Src/                    # Source files
    │   │   │   ├── main.c              # Main application (DFSDM + USB CDC)
    │   │   │   ├── stm32h7xx_hal_msp.c # HAL MSP initialization
    │   │   │   ├── stm32h7xx_it.c      # Interrupt handlers
    │   │   │   ├── syscalls.c          # System call implementations
    │   │   │   └── sysmem.c            # Memory management
    │   │   └── Startup/
    │   │       └── startup_stm32h755zitx.s # Startup assembly code
    │   ├── USB_DEVICE/                 # USB Device implementation
    │   │   ├── App/                    # Application layer
    │   │   │   ├── usb_device.c/.h     # USB device configuration
    │   │   │   ├── usbd_cdc_if.c/.h    # CDC interface implementation
    │   │   │   └── usbd_desc.c/.h      # USB descriptors
    │   │   └── Target/                 # Target specific configuration
    │   │       └── usbd_conf.c/.h      # USB device configuration
    ├── Common/                         # Shared files between cores
    │   └── Src/
    │       └── system_stm32h7xx_dualcore_boot_cm4_cm7.c # Dual-core boot
    ├── Drivers/                        # STM32 HAL and BSP drivers
    │   ├── BSP/                        # Board Support Package
    │   ├── CMSIS/                      # ARM CMSIS headers
    │   └── STM32H7xx_HAL_Driver/       # STM32H7 HAL driver
    └── Middlewares/                    # USB middleware
        └── ST/
            └── STM32_USB_Device_Library/ # USB Device library
                ├── Core/               # USB core functionality
                └── Class/CDC/          # CDC class implementation
```

### Key Files Description:

#### Firmware (STM32H755ZI):
- **`CM7/Core/Src/main.c`**: Main application implementing DFSDM configuration, DMA handling, and USB CDC data transmission
- **`CM7/USB_DEVICE/`**: Complete USB CDC implementation for data streaming to PC
- **`vibration_dfsdm.ioc`**: STM32CubeMX project file with peripheral configurations

#### PC Applications:
- **`read_cdc.c`**: C application to read vibration data from USB CDC interface and save to CSV format
- **`analyze_vibration.py`**: Python script for frequency domain analysis (FFT, Welch PSD, spectrogram)

## D. Installation and Example Usage

### Prerequisites
- STM32Cube tool chain
- STM32H755ZI Nucleo board
- USB cable for PC connection

### Firmware Installation
1. Build the project to generate the firmware binary.
2. Flash the firmware to the STM32H755ZI board using ST-Link.

### PC Application Usage

1. Power on the STM32H755ZI board first (Over ST-Link or V_IN etc.).
2. Connect the USB OTG connector (not the ST-Link) from the board to the PC.
3. Compile and run the `read_cdc.c` application to start reading data from the USB CDC interface. Specify the device path and output file using the `-p <path_to_tty_dev>` and `-o <path_to_output_csv_file>` options. For example:

    ```bash
    gcc read_cdc.c -O3 -o read_cdc
    timeout 5 ./read_cdc -p /dev/ttyACM0 -o data.csv
    ```

    You can use the `timeout` command in Linux to set a read timeout if needed.
4. Use the `analyze_vibration.py` script to analyze the saved CSV data. Specify the required arguments: `--input <path_to_csv_file>`, `--fs <sampling_rate>`, `--calib <calibration_factor>`, and `--outdir <output_directory>`. For example:

    ```bash
    python analyze_vibration.py --input data.csv --fs 12500 --calib 0.00000212 --outdir ./analysis
    ```

    This will generate frequency analysis plots (PSD, amplitude spectrum, spectrogram) in the specified output directory.

## E. Reference

1. [V2S200DZ Datasheet](https://static1.squarespace.com/static/6488b0b8150a045d2d112999/t/67521f2adb4a8e0c75ecfd53/1733435181145/V2S200DZ.pdf) from Syntiant.
2. [AN4990](https://www.st.com/resource/en/application_note/an4990-getting-started-with-sigmadelta-digital-interface-on-applicable-stm32-microcontrollers-stmicroelectronics.pdf) - Introduction to DFSDM peripheral from ST.
3. [RM0399](https://www.st.com/resource/en/reference_manual/rm0399-stm32h745755-and-stm32h747757-advanced-armbased-32bit-mcus-stmicroelectronics.pdf) - Reference manual of STM32H745/755/747/757 MCUs
4. [Introduction to USB with STM32](https://wiki.st.com/stm32mcu/wiki/Category:USB) - from WiKi by ST.
5. [Connect USB Devices on WSL](https://learn.microsoft.com/en-us/windows/wsl/connect-usb) - from Microsoft.